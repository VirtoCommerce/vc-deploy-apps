name: Platform Image Kustomization

on:
  push:
    branches: [ master ]
    paths:
        - '*platform.json'
        - '*kustomization-platform.yml'
  pull_request:
    branches: [ master ]
    paths:
        - '*platform.json'
        - '*kustomization-platform.yml'

jobs:
    build:
      # The type of runner that the job will run on
      runs-on: ubuntu-latest
  
      steps:
      - uses: actions/checkout@v2

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v1
        with:
          kustomize-version: "3.1.0"

      - name: Docker Login
        uses: azure/docker-login@v1
        with:
            login-server: docker.pkg.github.com
            username: $GITHUB_ACTOR
            password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Publish Docker Image
        shell: pwsh
        run: |
            $dockerWorkingDir = '${{ github.workspace }}/docker'
            Copy-Item platform-with-modules/* $dockerWorkingDir
            git diff --name-only HEAD HEAD~1 | Where-Object { $_ -match 'platform.json' } | ForEach-Object {
                $path = Convert-Path $_
                $imageTag = "docker.pkg.github.com/$('${{ github.repository }}'.ToLower())/$($path.Directory.Parent.Parent.Name)-$($path.Directory.Name):$('${{ github.sha }}'.Substring(0, 8))"
                Write-Host "File: $($_)"
                $json = Get-Content $_ | Out-String | ConvertFrom-Json
                Copy-Item $_ $dockerWorkingDir/platform.json -Force
                docker build $dockerWorkingDir --tag $imageTag --build-arg BASE_IMAGE="$($json.Platform)" 
                docker push $imageTag

                cd $path.Directory
                kustomize edit set image virtocommerce/platform=$imageTag
                git add .
            }

            git config user.email "github.actions@virtoway.com"
            git config user.name ${{ github.actor }}
            git commit -m "Update the platform image version"	
            $remoteRepo="https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/VirtoCommerce/vc-deploy-apps.git"
            git push $remoteRepo 