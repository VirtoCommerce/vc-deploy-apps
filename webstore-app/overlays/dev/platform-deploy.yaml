apiVersion: apps/v1
kind: Deployment
metadata:
  name: platform
spec:
  template:
    spec:
      initContainers:
        - name: init-platform
          command: ["/bin/bash", "-c", "python3 install-modules.py $(VC_PLATFORM_MODULES_CONFIG) /opt/virtocommerce/platform/Modules/ && rm -rf $(ELECTRONICS_THEME_LOCATION)/* && ./install-theme.sh $(ELECTRONICS_THEME_URL) $(ELECTRONICS_THEME_LOCATION) && rm -rf $(B2B_THEME_LOCATION)/* && ./install-theme.sh $(B2B_THEME_URL) $(B2B_THEME_LOCATION) && ./upload-assets.sh $(ASSETS_URL) $(ASSETS_LOCATION)"]
          env:
            - name: VC_PLATFORM_MODULES_CONFIG
              value: https://raw.githubusercontent.com/VirtoCommerce/vc-deploy-apps/master/webstore-app/overlays/dev/modules.json?8439F69CD65989A8EDE4F37181261D2E9764E81DB0F94742F9FE82C4830AC882
            - name: ELECTRONICS_THEME_URL
              value: https://vc3prerelease.blob.core.windows.net/packages/vc-theme-default-2.1.11.zip
            - name: ELECTRONICS_THEME_LOCATION
              value: /opt/virtocommerce/platform/wwwroot/cms-content/Themes/Electronics/default
            - name: B2B_THEME_URL
              value: https://vc3prerelease.blob.core.windows.net/packages/vc-demo-theme-b2b-1.0.0-alpha.1164.zip
            - name: B2B_THEME_LOCATION
              value: /opt/virtocommerce/platform/wwwroot/cms-content/Themes/B2B-store/default
            - name: ASSETS_URL
              value: https://vcbacpac.blob.core.windows.net/dac-packages/webstore_assets.zip
            - name: ASSETS_LOCATION
              value: /opt/virtocommerce/platform/wwwroot/cms-content/assets
          volumeMounts:
            - mountPath: /opt/virtocommerce/platform/Modules
              name: modules-data
            - mountPath: /opt/virtocommerce/platform/wwwroot/cms-content
              name: cms-content-data
        - name: init-sqldatabase
          env:
            - name: VC_SAMPLE_DATA_DB
              value: webstore-platform_source
      # containers:
      #   - name: vc-platform-web   
      #     env:
      #       - name: VirtoCommerce__SampleDataUrl
      #         value: https://vcbacpac.blob.core.windows.net/dac-packages/webstore_exported_data_without_binary.zip
