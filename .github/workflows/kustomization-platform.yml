name: Platform Image Kustomization

on:
  push:
    branches: [ master, feature/vp-3331-init-argo-cd-for-modules ]
    paths:
        - '**/platform.json'
        - '**/kustomization-platform.yml'

jobs:
    build:
      # The type of runner that the job will run on
      runs-on: ubuntu-latest
  
      steps:
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v1
        with:
          kustomize-version: "3.1.0"

      - name: Docker Login
        uses: azure/docker-login@v1
        with:
            login-server: docker.pkg.github.com
            username: $GITHUB_ACTOR
            password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Publish Docker Image
        shell: pwsh
        run: |
            $branch = '${{ github.ref }}'.Replace('refs/heads/', '')
            git clone https://github.com/${{ github.repository }}
            $repo = '${{ github.repository }}'.Replace('${{ github.repository_owner }}/', '')
            Set-Location $repo
            git checkout $branch

            $dockerWorkingDir = "${{ github.workspace }}/docker"
            New-Item -ItemType Directory -Name $dockerWorkingDir

            Copy-Item platform-with-modules/* $dockerWorkingDir
            git diff --name-only HEAD HEAD~1 | Where-Object { $_ -match 'platform.json' } | ForEach-Object {
                $path = Get-Item ${{ github.workspace }}/$repo/$_
                $prefix = Split-Path $_ -Leaf
                $ending = Split-Path $_ | Split-Path | Split-Path -Leaf
                $imageTag = "docker.pkg.github.com/$('${{ github.repository }}'.ToLower())/$($prefix)-$($ending):$('${{ github.sha }}'.Substring(0, 8))"
                Write-Host "File: $($path)"
                Write-Host "Image Tag: $($imageTag)"
                $json = Get-Content $_ | Out-String | ConvertFrom-Json
                Copy-Item $_ $dockerWorkingDir -Force
                docker build $dockerWorkingDir --tag $imageTag --build-arg BASE_IMAGE="$($json.Platform)" 
                docker push $imageTag

                cd $path.Directory
                kustomize edit set image virtocommerce/platform=$imageTag
                git add .
            }

            cd "${{ github.workspace }}/$($repo)"

            git config user.email "github.actions@virtoway.com"
            git config user.name ${{ github.actor }}
            git commit -m "Update the platform image version"	
            $remoteRepo="https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
            git push $remoteRepo 