name: Platform Image Kustomization

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
    build:
      # The type of runner that the job will run on
      runs-on: ubuntu-latest
  
      steps:
      - uses: actions/checkout@v2

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v1
        with:
          kustomize-version: "3.1.0"

      - name: Docker Login
        uses: azure/docker-login@v1
        with:
            login-server: docker.pkg.github.com
            username: $GITHUB_ACTOR
            password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Publish Docker Image
        shell: pwsh
        run: |
            $dockerWorkingDir = "$($env.GITHUB_WORKSPACE)/docker"
            Copy-Item platform-with-modules/* $dockerWorkingDir
            git diff --name-only HEAD HEAD~1 | Where-Object { $_ -match 'platform.json' } | ForEach-Object {
                Write-Host "File: $($_)"
                $json = Get-Content $_ | Out-String | ConvertFrom-Json
                Copy-Item $_ $dockerWorkingDir/platform.json -Force
                docker build $dockerWorkingDir --tag "docker.pkg.github.com/$('${{ github.repository }}'.ToLower())/platform-dev:${{ github.sha }}" --build-arg BASE_IMAGE="$($json.Platform)" 
                docker push "docker.pkg.github.com/$('${{ github.repository }}'.ToLower())/platform-dev:${{ github.sha }}"

                $path = Convert-Path $_
                $imageName = "$($path.Directory.Parent.Parent.Name)-$($path.Directory.Name):$('${{ github.sha }}'.Substring(0, 8))"
                cd $path.Directory
                $REPOSITORY = "docker.pkg.github.com/$('${{ github.repository }}'.ToLower())"
                kustomize edit set image virtocommerce/platform=$REPOSITORY/$imageName
            }

            git push $remoteRepo